<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>React CRUD - Lab</title>

    <!-- React & ReactDOM & Babel (CDN, cho lab/demo) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Một vài style mặc định để dễ nhìn */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background: #f5f5f5;
        }

        .btn {
            padding: 6px 10px;
            margin-right: 6px;
            cursor: pointer;
        }

        .btn-delete {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .btn-edit {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- App code -->
    <script type="text/babel">
        function SearchForm({ onChangeValue }) {
            return (
                <div style={{ marginBottom: 12 }}>
                    <input
                        type="text"
                        placeholder="Tìm theo name, username"
                        onChange={(e) => onChangeValue(e.target.value)}
                    />
                </div>
            );
        }


        function AddUser({ onAdd }) {
            const [adding, setAdding] = React.useState(false);
            const [user, setUser] = React.useState({
                name: "", username: "", email: "",
                address: { street: "", suite: "", city: "" },
                phone: "", website: ""
            });

            const handleChange = (e) => {
                const { id, value } = e.target;
                if (["street", "suite", "city"].includes(id)) {
                    setUser(prev => ({ ...prev, address: { ...prev.address, [id]: value } }));
                } else {
                    setUser(prev => ({ ...prev, [id]: value }));
                }
            };

            const handleAdd = () => {
                if (!user.name.trim() || !user.username.trim()) {
                    alert("Vui lòng nhập Name và Username!");
                    return;
                }
                onAdd(user);
                // reset form
                setUser({ name: "", username: "", email: "", address: { street: "", suite: "", city: "" }, phone: "", website: "" });
                setAdding(false);
            };

            return (
                <div style={{ marginTop: 12 }}>
                    <button className="btn" onClick={() => setAdding(true)}>Thêm</button>
                    {adding && (
                        <div style={{ marginTop: 8, padding: 8, border: '1px solid #ccc' }}>
                            <h4>Thêm người dùng</h4>
                            <div><label>Name: </label><input id="name" value={user.name} onChange={handleChange} /></div>
                            <div><label>Username: </label><input id="username" value={user.username} onChange={handleChange} /></div>
                            <div><label>Email: </label><input id="email" value={user.email} onChange={handleChange} /></div>
                            <div><label>City: </label><input id="city" value={user.address.city} onChange={handleChange} /></div>
                            <div style={{ marginTop: 6 }}>
                                <button className="btn" onClick={handleAdd}>Lưu</button>
                                <button className="btn" onClick={() => setAdding(false)}>Hủy</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }


        function ResultTable({ keyword, user, onAdded }) {
            const [users, setUsers] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [editing, setEditing] = React.useState(null);

            // 1) Tải dữ liệu 1 lần khi mount
            React.useEffect(() => {
                fetch("https://jsonplaceholder.typicode.com/users")
                    .then(res => res.json())
                    .then(data => { setUsers(data); setLoading(false); })
                    .catch(err => { console.error(err); setLoading(false); });
            }, []);

            // 2) Nếu có new user được thêm từ AddUser (prop user), cập nhật list
            React.useEffect(() => {
                if (user) {
                    setUsers(prev => [...prev, { ...user, id: prev.length + 1 }]);
                    onAdded();
                }
            }, [user]);

            // 3) Lọc theo keyword
            const filteredUsers = users.filter(u =>
                u.name.toLowerCase().includes(keyword.toLowerCase()) ||
                u.username.toLowerCase().includes(keyword.toLowerCase())
            );

            // 4) Xóa
            const removeUser = (id) => {
                setUsers(prev => prev.filter(u => u.id !== id));
            };

            // 5) Sửa (setEditing) và lưu (saveUser)
            const editUser = (u) => setEditing({ ...u, address: { ...(u.address || {}) } }); // deep copy shallow
            const handleEditChange = (field, value) => {
                setEditing(prev => ({ ...prev, [field]: value }));
            };
            const saveUser = () => {
                setUsers(prev => prev.map(u => u.id === editing.id ? editing : u));
                setEditing(null);
            };

            if (loading) return <div>Đang tải dữ liệu...</div>;

            return (
                <div style={{ marginTop: 12 }}>
                    <table>
                        <thead>
                            <tr><th>ID</th><th>Name</th><th>Username</th><th>Email</th><th>City</th><th>Hành động</th></tr>
                        </thead>
                        <tbody>
                            {filteredUsers.map(u => (
                                <tr key={u.id}>
                                    <td>{u.id}</td>
                                    <td>{u.name}</td>
                                    <td>{u.username}</td>
                                    <td>{u.email}</td>
                                    <td>{u.address?.city || ''}</td>
                                    <td>
                                        <button className="btn btn-edit" onClick={() => editUser(u)}>Sửa</button>
                                        <button className="btn btn-delete" onClick={() => removeUser(u.id)}>Xóa</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>

                    {/* Form sửa đơn giản (modal/trang con có thể làm sau) */}
                    {editing && (
                        <div style={{ marginTop: 12, padding: 10, border: '1px solid #ccc' }}>
                            <h4>Chỉnh sửa ID: {editing.id}</h4>
                            <div>
                                <label>Name: </label>
                                <input value={editing.name} onChange={e => handleEditChange('name', e.target.value)} />
                            </div>
                            <div>
                                <label>Username: </label>
                                <input value={editing.username} onChange={e => handleEditChange('username', e.target.value)} />
                            </div>
                            <div style={{ marginTop: 6 }}>
                                <button className="btn" onClick={saveUser}>Lưu</button>
                                <button className="btn" onClick={() => setEditing(null)}>Hủy</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }


        function App() {
            const [kw, setKeyword] = React.useState("");
            const [newUser, setNewUser] = React.useState(null);

            return (
                <div>
                    <h1>Quản lý người dùng</h1>
                    <SearchForm onChangeValue={setKeyword} />
                    <AddUser onAdd={setNewUser} />
                    <ResultTable keyword={kw} user={newUser} onAdded={() => setNewUser(null)} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>

</html>